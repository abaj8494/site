{{- $width := .Get "width" | default "100%" -}}
{{- $id := printf "tikz-algo-%d" .Ordinal -}}
<style>
#{{ $id }} {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: block;
  margin: 0 auto;
  width: {{ $width }};
}
#{{ $id }} svg {
  max-width: 100%;
  height: auto;
}
script[type="text/tikz"] {
  display: none;
}
</style>
<div id="{{ $id }}" class="tikz-algo lateximage">
  <script type="text/tikz" {{ if hugo.IsProduction }}data-show-console="true"{{ end }}>
\usepackage{tikz}
\usetikzlibrary{positioning,fit}
\usepackage{amsmath,amssymb}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}

\DontPrintSemicolon
\setlength{\algomargin}{1em}
\let\vec\mathbf

\begin{document}
\begin{tikzpicture}[x=1pt,y=1pt]
  \node[anchor=north west, inner sep=0pt, outer sep=0pt] (ALG) at (0,0) {%
{{ .Inner }}
  };
\end{tikzpicture}
\end{document}
  </script>
</div>

<script>
(function() {
  // Wait for TikzJax to render, then crop the SVG
  function cropSVG() {
    const container = document.getElementById('{{ $id }}');
    if (!container) {
      setTimeout(cropSVG, 100);
      return;
    }
    
    const svg = container.querySelector('svg');
    if (!svg) {
      setTimeout(cropSVG, 100);
      return;
    }

    try {
      // Get the bounding box of all actual content
      const bbox = svg.getBBox();
      
      // Add small padding
      const padding = 2;
      
      const naturalWidth = bbox.width + 2*padding;
      const naturalHeight = bbox.height + 2*padding;
      
      // Update viewBox to crop to content
      svg.setAttribute('viewBox', 
        `${bbox.x - padding} ${bbox.y - padding} ${naturalWidth} ${naturalHeight}`
      );
      

      const containerStyle = window.getComputedStyle(container);
      const targetWidth = containerStyle.width;
      
      // Set explicit dimensions on the SVG based on target width
      if (targetWidth && targetWidth !== 'auto' && targetWidth !== 'fit-content') {
        const targetWidthPx = parseFloat(targetWidth);
        // Force to target width regardless of natural size
        svg.setAttribute('width', targetWidthPx);
        svg.setAttribute('height', (naturalHeight * targetWidthPx / naturalWidth));
      } else {
        // No width constraint, use natural size
        svg.setAttribute('width', naturalWidth);
        svg.setAttribute('height', naturalHeight);
      }
      
      console.log('SVG sized for {{ $id }}:', {
        naturalWidth,
        naturalHeight,
        targetWidth,
        finalWidth: svg.getAttribute('width'),
        finalHeight: svg.getAttribute('height')
      });
    } catch (e) {
      console.error('Error cropping SVG for {{ $id }}:', e);
    }
  }

  // Start checking for SVG after a short delay
  setTimeout(cropSVG, 500);
})();
</script>
